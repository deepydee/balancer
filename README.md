# Локальный балансировщик

Представляет из себя docker-compose файл с сервисами для комфортной локальной разработки.

Список сервисов:
- **Traefik** - более простой и быстрый аналог Nginx. Принимает все запросы и проксирует к определённым проектам. Умеет автоматически находить контейнеры по labels.
- **Mailpit** - локальный SMTP с интерфейсом. Удобен для отладки отправки писем без фактической доставки на реальный email.
- **Portainer** - удобный интерфейс для взаимодействия с Docker. Управление образами, контейнерами, просмотр логов и выполнение команд.
- **Nginx** *(deprecated)* - локальный балансировщик. Использовался до Traefik, оставлен для обратной совместимости с древними проектами.
- **Nginx-gen** *(deprecated)* - следит за изменением переменных и пересоздаёт конфиг Nginx. Нужен только для Nginx, поэтому также устарел и не используется.

Требования к системе для работы с балансировщиком:
- ОС - Linux, MacOS, Windows.
- Git последней версии
- Установленный Docker последней доступной версии
- Установленный docker-compose не ниже 2 версии (1.* устарел)

**⚠️Порядок запуска проекта отличается**. Если разворачиваем балансировщик впервые, то п. 1, если обновляем уже существующий - п. 2. Пункты 0, 3 и 4 применимы всегда и не зависят от варианта установки 1 или 2.

### 0. Локальные домены *.test*
Автоматическое управление локальными доменами в разработке. ***In progress...***

Можно управлять доменами вручную, редактируя файл ***/etc/hosts*** . Каждый домен нужно вписывать с новой строки. В качестве IP адреса всегда указываем *127.0.0.1* . Пример:
```
127.0.0.1 new-project.test
```

Для работы сервисов балансировщика рекомендуем сразу добавить следующий список доменов в /etc/hosts .
- traefik.test
- portainer.test
- mailpit.test
### 1. Установка первоначальная
Настроим docker сеть для балансировщика.
```bash
docker network create dev-proxy
```

```bash
docker network create nginx-proxy
```

Клонируем репозиторий с файлами.
```bash
git clone https://git.dev-mage3.com/developers/balancer.git
```

Переходим в папку склонированного репозитория.
```bash
cd balancer
```

Остаётся запустить, дождаться загрузки необходимых образов и пользоваться.
```bash
docker-compose up -d
```
### 2. Обновление уже существующего
Подтягиваем изменения с Git.
```bash
git pull origin main
```

Обновляем используемые образы Docker.
```bash
docker-compose pull
```

Выполняем команду запуска. Обновятся только изменившиеся сервисы.
```bash
docker-compose up -d
```

### 3. Использование Mailpit
Подробнее про Mailpit можно почитать в [github разработчика](https://github.com/axllent/mailpit).

Для входа в веб-интерфейс Mailpit и просмотра перехваченных писем используйте адрес [http://mailpit.test](http://mailpit.test/) (добавьте его в /etc/hosts если не сделали этого в пункте 0).

Используйте следующие параметры на любом бэкенде
- Способ отправки - SMTP
- Сервер SMTP - mailpit.test
- Порт SMTP - 1025

Больше никаких данных не нужно! Поля с логином, паролем и типом шифрования оставляйте пустыми.

### 4. Проекты с nginx-proxy (deprecated)
Для обратной совместимости со старыми проектами, был сохранён Nginx. Что-бы проект со старой архитектурой заработал, необходимо поправить 78 строку файла docker-compose.yml, добавить нужные нам URL.

```
- traefik.http.routers.nginx.rule=Host(`sg.test`) || Host(`pma.sg.test`)
```

```
- traefik.http.routers.nginx.rule=Host(`sg.test`) || Host(`pma.sg.test`) || Host(`oop.test`) || Host(`pma.oop.test`)
```

После изменения строки нужно пересоздать контейнер, что-бы применить изменения.

```
docker-compose up -d
```

Иногда бывает что контейнер с Nginx не может обнаружить контейнер с нужным адресом, для этого необходимо выполнить команду

```
docker-compose up -d --force-recreate nginx
```
